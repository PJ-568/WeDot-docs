# 合并请求审核流程

> 本页旨在提供合并请求 (PR) 审核过程的标准。所以本页的受众是针对负责审核和批准合并请求的引擎维护者。
> 不过，许多内容对希望了解如何确保合并请求被合并的潜在贡献者也很有价值。

一个理想的合并请求流程：

  1. 贡献者打开一个解决特定问题的合并请求（通常是解决了 [issue](https://github.com/Wedot-Engine/WeDot) 或实现了[提案](https://github.com/Wedot-Engine/To-Do)）。
  2. 其他贡献者对合并请求提供反馈（包括审核和或批准合并请求，视情况而定）。
  3. 引擎维护者审核代码并视情况而定提供反馈、要求更改或批准合并请求。
  4. 另一位维护者专注于代码格式和代码质量，审核代码，并在满意后批准。
  5. 团队负责人或[生产团队](https://WeDot.top/teams#production)成员在确认合并请求已充分审核后合并合并请求。

<!-- TODO：生产团队页面 -->

本文档将更详细地解释步骤 2、3、4 和 5。有关合并请求工作流程的更详细说明，请参阅[合并请求工作流](pr_workflow.md)。

> 实践中这些步骤可能会合在一起。通常情况下，维护者会在同一时间对代码格式和代码质量进行评论，并同时批准合并请求。

一般来说，合并请求上的第一次互动是引擎维护者为合并请求分配标签并分配给熟悉该代码区域的人进行审核。

引擎维护者是 WeDot 项目仓库在 GitHub 上的“成员”在 WeDot 网站的 [团队页面](https://WeDot.top/teams) 上列出的人。
维护者负责引擎的某个领域。通常这意味着他们是被赋予更多信任以批准和推荐合并请求合并的人。

<!-- TODO：生产团队页面 -->

即使您并非维护者，您仍然可以通过审核代码、对合并请求提供反馈和在本地机器上测试合并请求以确认它们按预期工作来提供帮助。
许多当前活跃的维护者都是这样开始的，在成为维护者之前就一直在做这些事情。

## 代码审核和测试

以下是贡献者和引擎维护者可以对合并请求进行实质性代码审核的一些事项。

> 如果您想进行代码审核，但无法完成此列表中的所有事项，请在您的审核评论中说明。
> 即使您无法在本地构建合并请求以测试合并请求，仅提供代码评论也是很有帮助的（反之亦然）。
> 请自由地审核代码，但记得在您的审核结束时注明您仅审核了代码而未在本地测试更改。

### 1. 确认问题存在

合并请求需要解决问题，问题需要记录。确保合并请求链接并关闭（或解决）一个错误或一个提案。如果没有，请考虑要求贡献者更新合并请求的初始消息，详细说明合并请求旨在解决的问题。

> 在合并合并请求之前，应明确**为什么**需要该合并请求。
> 这有助于审核者确定合并请求是否确实解决了它声称要解决的问题，并有助于未来的贡献者理解代码为何如此编写。

### 2. 测试合并请求并查找回归

虽然严格的代码审核和持续集成帮助确保所有合并请求按预期工作，但总会有潜在的错误，有时候一个修复的更改反而引入了别的错误。
维护者要避免合并包含回归（regression）的代码，即使它按预期解决了问题。

在审核合并请求时，确保合并请求按照所述内容（如修复某错误或实现新功能）编写，并且更改不会破坏合并请求目标范围之外的任何内容。
您可以通过运行编辑器并尝试一些编辑器的常见功能（向场景添加对象、运行 GDScript、打开和关闭菜单等）来完成此操作。
在审核代码时，注意其他部分引擎中的可疑更改。
有时在 rebase 的过程中会出现贡献者未注意到的更改。

### 3. 进行代码审核

代码审核通常由已经在指定领域有经验的人完成。
他们可能能够提供使代码更快、更有组织或更符合习惯用法的想法。
但，即便您不是老手，您也可以进行代码审核，在您感到舒适的范围内提供反馈即可。
这样做对区域维护者有价值（毕竟多一对眼睛总是好的），也对您自己有价值，因为它可以帮助您更熟悉该领域的代码，并让您了解其他人是如何解决问题的。
实际上，审核经验丰富的引擎维护者的代码是了解代码库的好方法。

以下是在审核代码时需要思考和注意的一些事项：

- **代码仅触及合并请求（和提交消息）中声称有必要更改的范围**：
  当您看到代码中的随机问题时，可能会忍不住去修复它们。
  然而，这会使合并请求难以审核，并且很难在提交历史中溯源。
  略微修补相关区域没什么问题，但最好把错误单独修复在一个新的合并请求中。
- **代码正确使用 WeDot 自身的 API 和模式**：
  一致性非常重要，已存在于代码库中的解决方案优于临时解决方案。
- **核心区域是否受到更改的影响**：
  有时一个旨在解决局部问题的合并请求可能会产生超出其范围的广泛影响。
  通常最好将代码更改限制在问题出现的地方。
  如果您认为解决方案需要超出问题范围的更改，最好寻求团队领导的意见，他们可能有其他解决该问题的想法。

### 4. 与贡献者迭代并改进合并请求

维护者应在代码中发现需要更改的地方时提供反馈和改进建议。建议按照重要性顺序提出建议：首先解决总体代码设计和解决问题的方法，然后确保代码是引擎的最优实现，最后进行[代码格式审核](#代码格式审核)。

> **在审核过程中尽早沟通合并的障碍**：
>
> 如果合并请求有明显的阻碍或由于其他原因可能不会被合并，这一事实应尽早并清楚地传达。
> 我们不喜欢让人为难，因为说“对不起，不行”感觉不好。

在审核合并请求时，请遵守 WeDot [行为准则](https://WeDot.top/code-of-conduct)，特别是以下几点：

<!-- TODO：行为准则 -->

- 始终保持礼貌。友善和礼貌。
- 始终假设他人有积极意图。
- 欢迎反馈，但请保持批评建设性。

在与贡献者迭代合并请求时，避免以下事项：

- **重复审核**：

  换句话说，最好一次性审核整个合并请求，避免多次返回指出可以在首次审核中指出的问题。
  虽然有时候难以避免，但我们应该尽量一次解决所有问题。

- **太挑剔**：

  代码质量在引擎的不同区域可以有所不同。
  一般来说，我们在核心区域和性能敏感区域的代码质量标准比编辑器代码更高。
  特别是在我们可以在贡献者完成修改后自己提交一个优化的合并请求。

- **扩大合并请求的范围**：

  提供上下文或类似问题或提案的相关信息是有帮助的，但在处理其他问题的同时“顺便修复那边的问题”或“能否再加点这个？”有时并不公平。
  在决定额外修复是否在范围内时，多想想，但请尽量保持范围接近原始合并请求。

最后，不要因必须独自处理合并请求觉得有压力。请随时在 [QQ 群组](https://qm.qq.com/cgi-bin/qm/qr?authKey=G%2BR%2FKlLQBeH71b1Mhe4t2gM%2B8rLXndOEPhPtDgWgTudLUtGUgpMrNAWD87x%2F64ta&k=IPTGQ3zH_W8IAzaFrnLLGF2kplhv-EeM&noverify=0&group_code=670915303)寻求帮助，或在 [Discord](https://discord.com/invite/MDDHEQNJaY) 的频道中寻求帮助。您也可以等待其他团队或请求他们的帮助。

### 5. 批准合并请求

审核代码后，如果您认为代码已准备好合并到引擎中，则可以继续“批准”它。
请务必评论说明您的审核过程（即说明您是否在本地运行了代码，是否还审核了样式和正确性等）。
即使您不是引擎维护者，批准合并请求也会向其他人发出信号，表明代码良好且很可能解决了合并请求声称要解决的问题。
作为非引擎维护者批准合并请求并不能保证代码会被合并，其他人仍会审核，所以别害羞。

## 代码格式审核

最好在代码格式（风格）或可读性审核之前进行代码审核，因为贡献者在改格式前需要知道维护者对这个请求的看法。
换句话说，维护者不应要求贡献者更改可能需要在后续审核中重写的代码格式。
同样，维护者应避免在合并请求尚未审核的情况下要求贡献者 rebase。
也就是说，如果您不自信足以提供代码正确性的审核，提前提供关于代码格式和清晰度的评论是完全合适的，也是非常受欢迎的。

实际上，代码格式审核可以作为实质性代码审核的一部分进行。
重要的是，在合并合并请求之前，需要对实质性代码和代码格式进行全面审核和考虑。

在审核代码格式时，特别注意确保合并请求遵循[代码格式指南]()。虽然 `clang-format` 和各种持续集成检查可以捕获许多不一致之处，但它们远非完美，无法检测某些问题。例如，您应检查：

- 头文件包含的风格是否一致。
- 标识符使用 `snake_case` 并遵循我们的命名约定。
- 如果方法参数用于返回值，则需以 `p_*` 或 `r_*` 开头。
- 即使是一行条件语句，也要适当使用大括号。
- 代码间距适当（方法之间恰好有一行空格，方法体内部没有不必要的空行）。

> 此列表并不完整，也不旨在完整。请参阅[代码格式指南]()文档以获取完整的规则集。请记住，`clang-format` 可能无法捕获所有您希望它捕获的内容，因此还请做好心理准备。

<!-- TODO：代码格式指南 -->

## 合并合并请求

一般来说，合并请求应仅由生产团队成员或团队领导者合并，尤其是涉及其负责的引擎部分的合并请求。
例如，网络团队的领导可以合并不会大幅更改非网络部分代码的网络合并请求。

实际上，最好等待生产团队成员合并合并请求，因为他们对整个代码库最熟悉，并且可能更深入地了解此合并请求可能与其他最近或是即将发生的更改冲突的原因（或延迟合并请求的其他原因）。
请随时留言说合并请求应该准备好合并。

在合并合并请求之前，应采取以下步骤。对于简单或直接的合并请求，可以灵活执行这些步骤，但对于复杂或有风险的合并请求，应仔细执行。

作为贡献者，您可以通过自己完成其中一些步骤来帮助推进合并请求。

### 1. 从合适的人或团队的获取反馈

生产团队成员应确保在合并合并请求之前，指派合适的人查看了合并请求。在某些情况下，可能需要多人参与。在其他情况下，只需一个实质性的批准即可合并代码。

一般来说，尽量不要仅根据一条审核评论来合并内容，尤其当这还是您自己的审核评论。
请从另一位维护者那里获取第二意见，并确保所有可能受影响的团队都参与了审核者。
比方说，如果合并请求添加了文档，通常让区域维护者检查其事实正确性，并让文档维护者检查其格式、风格和语法正确性。

我的经验是，至少有一个相关专家应已批准合并请求的正确性，同时另一个维护者应已批准合并请求的代码格式。这两者之一可以是合并合并请求的人。

确保审核和批准是由该特定引擎领域内有能力的人留下的。即使是 WeDot 组织中的核心成员，也可能在没有相关专业知识的情况下留下审核评论。

> 一种找到可能准备合并的合并请求的简单方法是过滤已批准的合并请求并按最近更新排序。
> 您可以使用[此链接](https://github.com/Wedot-Engine/WeDot/pulls?q=is%3Apr+is%3Aopen+review%3Aapproved+sort%3Aupdated-desc)查看主 WeDot 仓库中的。

### 2. 获取社区反馈

如果合并请求难以吸引审核者，您可能需要更广泛地寻求帮助审核。请考虑：

- 询问报告 bug 的人该合并请求是否解决了他们的 bug；
- 询问最近编辑该文件的贡献者是否可以查看；
- 询问来自其他领域的经验丰富的维护者是否可以提供反馈。

### 3. Git 检查清单

- **确保合并请求仅包含一个提交**：

  当每个提交都是自包含的（提交的内容的就是针对一项的更改）并且可以用于构建干净且工作的引擎版本时，可以据情况合并多个提交的合并请求，但通常我们要求所有合并请求只有一个提交。
  这有助于我们保持 Git 历史记录的整洁。

- **审核过程中所做的修复必须合并到主提交中**：

  对于多提交的合并请求，请检查这些修复是否已合并到相关提交中，而不是简单地叠加在所有提交之上。

- **确保合并请求没有合并冲突**：

  贡献者可能需要在其相关分支（例如 `main` 或 `3.x`）上 rebase 并手动解决合并冲突。
  即使没有合并冲突，贡献者可能也需要 rebase，尤其针对旧的合并请求，因为 GitHub 冲突检查器有可能无法捕获所有冲突，或者因为在贡献者使用的分支的持续集成和现在我们使用的持续集成不一样了。

- **检查正确的提交归属**：

  如果贡献者使用的作者签名未列在其 GitHub 账户中，GitHub 不会将合并的合并请求链接到其账户。
  这会导致他们在 GitHub 历史记录中不可信，并在 GitHub UI 中显示为新贡献者，即使他们已经进行了多次贡献。

  是否修复这个问题取决于用户，他们可以通过使用与 GitHub 账户相同的电子邮件签署 Git 提交，或将用于 Git 提交的电子邮件添加到他们的 GitHub 个人资料中来修复。

- **检查正确的提交消息**：

  我们要求所有提交消息遵循 [PJ568 提交说明规范](https://github.com/PJ-568/git-commit-regulation)。详情请参阅主 WeDot 仓库中的 [CONTRIBUTING.md](https://github.com/Wedot-Engine/WeDot/blob/main/CONTRIBUTING.md#提交信息格式) 贡献指北。

### 4. GitHub 检查清单

- **验证合并请求的目标分支**：

  大多数 WeDot 开发活动围绕 `main` 分支进行。因此，大多数合并请求必须对该分支提交。
  合并请求可以从 `main` 分支回退到其他分支。
  请注意，贡献者可能会在他们正在使用的版本（例如 `3.3`）上创建合并请求，请引导他们针对更高版本的分支（例如 `3.x`）进行更改。如果更改不适用于 `main` 分支，初始合并请求可以针对当前的维护分支（如 `3.x`）。
  贡献者可以为每个目标分支创建多个合并请求，特别是当更改不易回退时。如果可能，可以选择 cherry-pick。

> 已经提交的合并请求的目标分支是可以更改的，但请注意后果。由于无法与推送同步，目标分支的更改将不可避免地标记整个维护者列表进行审核。这也可能导致持续集成无法正常运行。推送应该有助于解决这些问题，但如果不行，建议打开一个新的、干净的合并请求。

- **确保分配了适当的里程碑**：

  这将使合并合并请求时更明显哪个版本要包含提交的更改。请注意，里程碑不是具有约束力的合同，不能保证该版本一定会包含合并请求。如果在版本发布前未合并合并请求，里程碑应该被移动（合并请求本身可能需要更改目标分支）。

  同样，当合并具有高于当前版本的里程碑或“通配符”里程碑（例如“4.x”）的合并请求时，请确保将里程碑更新为当前版本。

- **确保合并请求的初始消息符合 PJ568 提交说明规范且评论关联问题**：

  这些关键字将合并请求和引用的问题关联起来，并允许 GitHub 在合并更改时自动关闭后者。请注意，这仅适用于目标为 `main` 分支的合并请求。对于其他合并请求，您需要手动关闭相关问题。使用“在 #…… 修复”或“在 #…… 解决”评论清楚地表明状态，以便未来的贡献者了解。

- **对于合并请求关闭的问题，添加最相关的里程碑**：

  换句话说，如果合并请求针对 `main` 分支，但随后也被 cherry-pick 到 `3.x`，则下一个 `3.x` 发布要是关闭问题的适当里程碑。

### 5. 合并合并请求

如果您确定您很适合合并合并请求（即您是生产团队成员或该领域的团队负责人），并且您确信合并请求已充分审核，一旦完成这些步骤，您可以继续合并合并请求。
